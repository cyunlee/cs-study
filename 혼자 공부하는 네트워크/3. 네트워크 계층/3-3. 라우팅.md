# 3-3. 라우팅
라우터의 핵심 기능 `패킷이 이동할 최적의 경로를 설정한 뒤 해당 경로로 패킷을 이동시키는 것`을 라우팅이라고 한다. 
**라우팅의 분류**와 라우팅에 사용되는 **라우팅 테이블**에 대해 알아보자.

## 라우터
> 네트워크 계층의 핵심 장비

### 홉
> 라우팅 도중 패킷이 호스트 - 라우터, 라우터 - 라우터 간에 이동하는 하나의 과정

여러 개의 홉을 거쳐서 라우팅이 이루어진다.

<hr>

## 라우팅 테이블
> 특정 수신지까지 도달하기 위한 정보를 명시한 일종의 표

라우터의 핵심은 라우터가 저장하고 관리하는 **라우팅 테이블**이다.

### 라우팅 테이블의 핵심 정보
- **수신지 IP 주소 & 서브넷 마스크**
  - 최종적으로 패킷을 전달할 대상
- **다음 홉(next hop)**
  - 최종 수신지까지 가기 위해 다음으로 거쳐야 할 호스트의 IP 주소나 인터페이스 (게이트웨이)
- **네트워크 인터페이스**
  - 패킷을 내보낼 통로
- **메트릭**
  - 해당 경로로 이동하는 데에 드는 비용

<hr>

## 정적 라우팅과 동적 라우팅

### 정적 라우팅
> 사용자가 수동으로 직접 채워 넣은 라우팅 테이블을 기반으로 라우팅하는 것

### 동적 라우팅
> 자동으로 라우팅 테이블 항목을 만들고, 이를 이용하여 라우팅하는 것

#### 동적 라우팅 프로토콜
> 특정 수신지까지 도달하기 위한 최종 경로를 찾기 위해 라우터끼리 자신의 정보를 교환하는 것

#### AS(Autonomous System)
> 라우터들의 집단 네트워크

<hr>

## 라우팅 프로토콜
> 라우터끼리 자신들의 정보를 교환하며 패킷이 이동할 최적의 경로를 찾기 위한 프로토콜

### IGP(Interior Gateway Protocol)
> AS 내부에서 수행되는 라우팅 프로토콜

#### RIP
> **거리 벡터**를 기반

최종 목적지까지 **홉 수가 가장 적은 경로**를 최적의 경로라고 판단한다.

#### OSPF
> **링크 상태**를 기반

링크 상태 데이터베이스을 통해, **대역폭이 높은 링크**일수록 메트릭이 낮은 경로로 인식한다.
OPSF는 AS를 **에어리어** 단위로 나눈 후, 구분된 에어리어 내에서만 링크 상태를 공유한다.
에어리어와 에어리어의 연결은 **ABR**이라는 라우터가 담당한다.

### EGP(Exterior Gateway Protocol)
> AS 외부에서 수행되는 라우팅 프로토콜

#### BGP
> AS 간의 통신에서 사용되는 대표적인 프로토콜

다른 AS와 통신하기 위해서 다른 AS의 BGP 라우터와 통신해야 하는데, BGP 라우터(피어)끼리 통신하는 과정을 **피어링**이라고 한다.
BUT, BGP는 RIP와 OSPF에 비해 최적의 경로 결정 과정이 복잡하다. 다양한 **속성과 정책**을 고려하기 때문이다.

- 속성
  - AS-PATH
  - NEXT-HOP
  - LOCAL-PREF
- 정책
  - 특정 AS 우대, 보안과 안정성 우선시, 성능 우선시 등등.. AS 관리 주체에 따라 다름

<hr>

## 추가 조사

### 라우터의 역할 및 동작 방식

#### 라우터
> LAN을 넘어선 다른 네트워크와 통신을 할 때 최적의 도달 경로를 파악하기 위해 사용되는 네트워크 계층의 장비

#### 역할
패킷의 목적지 IP 주소를 확인하여 해당 네트워크 주소의 경로를 지정한다.

#### 동작 방식
라우터마다 여러 경로 정보를 가지고 있으며, 들어오는 패킷이 어떻게 하면 최적의 경로로 목적지에 도달할지 파악하여 포워딩한다.
이를 위해 라우터는 다양한 경로 정보를 수집하며, 라우팅 테이블에 저장한다.

#### + 라우터가 패킷을 라우팅하는 방식
- 경로 지정
  - 패킷이 들어오면 패킷의 도착지 IP를 라우팅 테이블에서 찾아서 경로를 지정한다.
- 브로드캐스트 컨트롤
  - 라우터는 분명한 목적지 정보가 있을 때만 통신을 허용한다. 라우터로 들어온 패킷의 목적지 주소가 라우팅 테이블에 없다면, 패킷을 폐기한다.
  - 반면 스위치는 목적지가 없으면 들어오는 패킷을 모든 포트에 전송한다.
  - 라우터는 멀티캐스트 정보를 습득하지 않고, 브로드캐스트 패킷을 전달하지 않는다. 따라서 패킷이 다른 네트워크로 전달되지 않는다.
- 프로토콜 변환
  - 서로 다른 데이터 링크 계층 프로토콜을 사용하는 네트워크를 연결할 수 있다.
  - 2계층까지 헤더 정보를 벗겨내고 3계층 주소를 확인한 후 2계층 헤더 정보를 새로 입혀 외부로 내보낸다.
    - ex) LAN - Ethernet, WAN - PPP, HDLC

### 라우팅 테이블의 역할 및 동작 방식

#### 라우팅 테이블
> 라우터가 패킷을 받았을 때 해당 패킷을 어디로 이동시킬지에 대한 정보가 써져 있는 표

#### 역할
목적지 네트워크로 가는 최적의 경로를 결정하고자 사용되는 데이터 구조

#### 동작 방식
- 들어오는 패킷의 목적지 IP 주소를 확인한다.
- 라우팅 테이블을 조회하여 패킷의 목적지 IP 주소와 라우팅 테이블에 있는 네트워크 주소를 비교한다.
  - 이 때, Longest Prefix Matching을 사용해서 일치하는 항목을 찾는다.
  - **Longest Prefix Matching** : 목적지 주소와 맞는 범위를 탐색할 때, 가장 길게 매칭되는 범위를 선택하는 것
    - ex) 11001000 00010111 00011000 01111111 주소를 가진 패킷이 들어왔다.
    - 1번 링크 : 11001000 00010111 00011000 ********
      2번 링크 : 11001000 00010111 00011*** ********
      1번과 2번 링크 둘다 매칭이 되지만 더 구체적으로 매칭되는 링크는 1번이므로, 1번 링크로 내보낸다.
- 여러 경로가 일치할 경우 메트릭(경로의 우선순위를 나타내는 값)이 더 작은 경로를 최적의 경로로 선택한다.
- 선택된 경로에 따라 패킷을 다음 홉으로 전달하고, 패킷에 출발 인터페이스를 설정한다.
  - 패킷이 나갈 적절한 물리적 연결을 결정하는 것으로, 라우터가 패킷 전송 경로를 구체화하는 마지막 단계이다.

## LocalHost(127.0.0.1) 데이터 전송 과정

Localhost로 데이터를 전송하는 것은 호스트 자체 내에서 네트워크를 통해 데이터를 송수신하는 상황이다.
이 경우 NIC는 사용되지 않는다. 대신, OS 커널의 네트워크 스택 내부에서 처리된다.

Localhost IP 주소는 예약된 주소로, 네트워크 내부로 나가지 않고 로컬 시스템 내에서 처리된다.
네트워크 계층에서 127.0.0.1로 목적지 IP 주소가 설정되면, 패킷은 데이터 링크 계층의 루프백 인터페이스로 전달된다.
**루프백 인터페이스(lo)**는 물리적 네트워크 하드웨어와 독립적이며, 데이터가 시스템 내부에서 순환(루프백)할 수 있게 한다.

루프백 인터페이스를 거친 데이터는 다시 네트워크 -> 전송 -> 애플리케이션으로 전달된다.

## 엔드포인트가 NAT 디바이스 뒤에 있는 경우

### 외부에서 서버로 접근

NAT 뒤에 있는 서버는 외부에서 접근이 불가능하다.

#### 해결책

- 포트 포워딩 : NAT 라우터에서 외부 포트를 내부 서버의 포트로 포워딩한다.
  - NAT 장비에 접근 권한이 있다면 포트 포워딩을 할 수 있다.
- 리버스 프록시 : 외부 요청을 프록시 서버가 받아 NAT 뒤의 서버로 전달한다.
- VPN : 외부 클라이언트가 VPN을 통해 NAT 뒤의 네트워크에 접속하도록 설정한다.
- Dynamic DNS : 동적 DNS로 외부 접근 가능하다.
- 클라우드 서비스 : 백엔드 서버를 클라우드 플랫폼에 배치한다. 
- SSH 터널링 : NAT 밖에 있는 공인 IP 서버에 SSH로 접속하여 터널링을 통해 NAT 뒤의 서버에 접근한다.

### 서버에서 외부로 접근

- 외부 서비스는 요청을 보낸 IP 주소를 확인하는데, 일부 외부 서비스는 IP 화이트리스트를 설정해서 특정 IP만 접근 가능하게 제한한다.
- NAT 뒤에 있는 서버에서 요청을 보낼 때, 서버는 사설 IP를 이용하지만 NAT 디바이스가 공인 IP를 바꿔서 외부로 요청을 보낸다.
- 만약 동적으로 IP 주소를 할당하면, 외부 서비스에 등록한 IP와 실제 요청의 IP가 다를 수 있다.
  - NAT의 공인 IP를 정적으로 고정으로 설정한다.
  - NAT 장비의 공인 IP를 외부 서비스에 등록한다. (외부 서버는 해당 IP에서 오는 요청만 허용하게 된다.)